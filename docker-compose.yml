version: '3.8'

services:
  cs-server:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - cs-network
    environment:
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_DB=0
      # BestTime API
      - BESTTIME_PRIVATE_KEY=pri_aff50a71a038456db88864b16d9d6800
      - BESTTIME_PUBLIC_KEY=pub_4f4f184e1a5f4f50a48e945fde7ab2ea
      - BESTTIME_ENDPOINT_BASE_V1=https://besttime.app/api/v1
      # Scheduler Configuration
      - VENUES_CATALOG_REFRESH_MINUTES=43200
      - VENUES_LIVE_REFRESH_MINUTES=5
      - WEEKLY_FORECAST_CRON=0 0 * * 0
      # Server Configuration
      - SERVER_PORT=8080
      - LOG_LEVEL=INFO
      # Google Places API (for vibe attributes)
      - GOOGLE_PLACES_API_KEY=${GOOGLE_PLACES_API_KEY:-}
      - VIBE_ATTRIBUTES_REFRESH_ENABLED=true
      - VIBE_ATTRIBUTES_REFRESH_CRON=0 3 * * *

  redis:
      image: redis:latest
      ports:
        - "6379:6379"
      restart: unless-stopped
      networks:
        - cs-network
      volumes:
        # 1. Persist the data directory
        # This maps the 'redis_data' Docker volume to the container's default data dir
        - redis_data:/data
        # 2. Mount the custom config file
        - ./config/redis.conf:/usr/local/etc/redis/redis.conf
      command: redis-server /usr/local/etc/redis/redis.conf # Tell Redis to use the custom config
      
networks:
  cs-network:
    name: cs-network
    driver: bridge

volumes:
  # Define the volume for persistent storage
  redis_data:
